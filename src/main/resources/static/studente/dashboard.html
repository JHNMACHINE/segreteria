<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Studente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    header {
      background-color: #0d6efd;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>

<header>
  <h1>Area Studente</h1>
  <div>
    <span id="nomeStudente" class="me-3"></span>
    <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container mt-4">
  <div id="contenuto-dashboard">
    <h2>Bentornato!</h2>
    <p>Qui potrai gestire il tuo piano di studi, prenotarti agli appelli e accettare i voti.</p>

    <div id="sezione-piano-studi" class="my-4">
      <h4>Piano di Studi</h4>
      <ul id="lista-esami" class="list-group"></ul>
    </div>

    <div id="sezione-appelli" class="my-4">
      <h4>Appelli disponibili</h4>
      <ul id="lista-appelli" class="list-group"></ul>
    </div>

    <div id="sezione-voti" class="my-4">
      <h4>Voti da accettare</h4>
      <ul id="lista-voti" class="list-group"></ul>
    </div>
  </div>
</div>

<footer class="text-center py-4 mt-5 border-top">
  <small>&copy; 2025 - Segreteria Universitaria. Tutti i diritti riservati.</small>
</footer>

<script>
  const token = localStorage.getItem('jwtToken');
  if (!token) {
    window.location.href = '/login.html';
  }

  function logout() {
    localStorage.removeItem('jwtToken');
    window.location.href = '/login.html';
  }

  function eseguiOperazione(nomeOperazione, parametri = []) {
    return fetch('/api/v1/operazione', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        nomeOperazione: nomeOperazione,
        parametri: parametri
      })
    })
    .then(res => {
      if (!res.ok) {
        throw new Error("Errore nella richiesta");
      }
      return res.json();
    });
  }

  // Carica i dati dello studente (nome e cognome)
  eseguiOperazione('getInfoStudente')
    .then(data => {
      document.getElementById('nomeStudente').innerText = data.nome + ' ' + data.cognome;
    })
    .catch(err => console.error('Errore caricamento info studente:', err));

  // Carica il piano di studi
  eseguiOperazione('getPianoDiStudi')
    .then(esami => {
      const lista = document.getElementById('lista-esami');
      esami.forEach(e => {
        const item = document.createElement('li');
        item.className = 'list-group-item';
        item.innerText = `${e.nome} - ${e.cfu} CFU`;
        lista.appendChild(item);
      });
    })
    .catch(err => console.error('Errore caricamento piano di studi:', err));

  // TODO: Carica appelli e voti da accettare con operazioni simili
  eseguiOperazione('getAppelliPrenotabili')
    .then(appelli => {
      const lista = document.getElementById('lista-appelli');
      appelli.forEach(a => {
        const item = document.createElement('li');
        item.className = 'list-group-item';
        item.innerText = `${a.nomeEsame} - ${a.data}`;
        lista.appendChild(item);
      });
    })
    .catch(err => console.error('Errore caricamento appelli:', err));

  eseguiOperazione('getVotiDaAccettare')
    .then(voti => {
      const lista = document.getElementById('lista-voti');
      voti.forEach(v => {
        const item = document.createElement('li');
        item.className = 'list-group-item';
        item.innerText = `${v.esame.nome} - Voto: ${v.valutazione}`;
        lista.appendChild(item);
      });
    })
    .catch(err => console.error('Errore caricamento voti:', err));
</script>
</body>
</html>