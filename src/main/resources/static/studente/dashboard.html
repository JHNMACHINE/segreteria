<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Studente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    header {
      background-color: #0d6efd;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    footer {
      background-color: #f8f9fa;
      border-top: 1px solid #ddd;
      padding: 20px;
    }
  </style>
</head>
<body>

<header>
  <h1>Area Studente</h1>
  <div>
    <span id="nomeStudente" class="me-3"></span>
    <button class="btn btn-light btn-sm" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container mt-4">
  <div id="contenuto-dashboard">
    <h2>Bentornato! <span id="nomeCompleto"></span></h2> <!-- Aggiungi un span per il nome e cognome -->
    <p>Qui potrai gestire il tuo piano di studi, prenotarti agli appelli e accettare i voti.</p>

    <div id="sezione-piano-studi" class="my-4">
      <h4>Piano di Studi</h4>
      <ul id="lista-esami" class="list-group"></ul>
    </div>

    <div id="sezione-appelli" class="my-4">
      <h4>Appelli disponibili</h4>
      <ul id="lista-appelli" class="list-group"></ul>
    </div>

    <div id="sezione-voti" class="my-4">
      <h4>Voti da accettare</h4>
      <ul id="lista-voti" class="list-group"></ul>
    </div>
  </div>
</div>

<footer class="text-center py-4 mt-5 border-top">
  <small>&copy; 2025 - Segreteria Universitaria. Tutti i diritti riservati.</small>
</footer>

<script>
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login.html';
  }

  function logout() {
    localStorage.removeItem('token');
    window.location.href = '/studente/login.html';
  }

  function getMatricolaFromToken() {
    const jwt = JSON.parse(atob(token.split('.')[1])); // Decodifica il payload del token JWT
    return jwt.matricola; // Presupponendo che la matricola sia nel payload
  }

  const matricola = getMatricolaFromToken();

  // Funzione per eseguire le operazioni (come chiamate API)
  function eseguiOperazione(nomeOperazione, parametri = []) {
    return fetch('/api/v1/operazione', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({
        nomeOperazione: nomeOperazione,
        parametri: parametri
      })
    })
    .then(res => {
      if (!res.ok) {
        throw new Error("Errore nella richiesta");
      }
      return res.json();
    });
  }

  // Carica le informazioni dello studente (nome e cognome)
  eseguiOperazione('getInfoStudente', [matricola])
    .then(data => {
      document.getElementById('nomeStudente').innerText = data.nome + ' ' + data.cognome;
      document.getElementById('nomeCompleto').innerText = data.nome + ' ' + data.cognome; // Aggiungi nome e cognome al saluto
    })
    .catch(err => console.error('Errore caricamento info studente:', err));

  // Carica il piano di studi
  eseguiOperazione('getPianoDiStudi', [matricola])
    .then(esami => {
      const lista = document.getElementById('lista-esami');
      esami.forEach(e => {
        const item = document.createElement('li');
        item.className = 'list-group-item';
        item.innerText = `${e.nome} - ${e.cfu} CFU`;
        lista.appendChild(item);
      });
    })
    .catch(err => console.error('Errore caricamento piano di studi:', err));

  // Carica gli appelli prenotabili
  eseguiOperazione('getAppelliPrenotabili', [matricola])
    .then(appelli => {
      const lista = document.getElementById('lista-appelli');
      appelli.forEach(a => {
        const item = document.createElement('li');
        item.className = 'list-group-item';
        item.innerText = `${a.nomeEsame} - ${a.data}`;

        // Crea un pulsante per prenotare l'esame
        const prenotaBtn = document.createElement('button');
        prenotaBtn.className = 'btn btn-primary btn-sm ms-3';
        prenotaBtn.innerText = 'Prenota';
        prenotaBtn.onclick = () => prenotaEsame(a.id);

        item.appendChild(prenotaBtn);
        lista.appendChild(item);
      });
    })
    .catch(err => console.error('Errore caricamento appelli:', err));

  // Carica i voti da accettare
  eseguiOperazione('getVotiDaAccettare', [matricola])
    .then(voti => {
      const lista = document.getElementById('lista-voti');
      voti.forEach(v => {
        const item = document.createElement('li');
        item.className = 'list-group-item';
        item.innerText = `${v.esame.nome} - Voto: ${v.valutazione}`;

        // Crea pulsanti per accettare e rifiutare il voto
        const accettaBtn = document.createElement('button');
        accettaBtn.className = 'btn btn-success btn-sm ms-3';
        accettaBtn.innerText = 'Accetta';
        accettaBtn.onclick = () => accettaVoto(v.id);

        const rifiutaBtn = document.createElement('button');
        rifiutaBtn.className = 'btn btn-danger btn-sm ms-2';
        rifiutaBtn.innerText = 'Rifiuta';
        rifiutaBtn.onclick = () => rifiutaVoto(v.id);

        item.appendChild(accettaBtn);
        item.appendChild(rifiutaBtn);
        lista.appendChild(item);
      });
    })
    .catch(err => console.error('Errore caricamento voti:', err));

  // Funzione per accettare un voto
  function accettaVoto(votoId) {
    eseguiOperazione('aggiornaStatoVoto', [votoId, true])
      .then(() => alert('Voto accettato'))
      .catch(err => alert('Errore nell\'accettazione del voto: ' + err));
  }

  // Funzione per rifiutare un voto
  function rifiutaVoto(votoId) {
    eseguiOperazione('aggiornaStatoVoto', [votoId, false])
      .then(() => alert('Voto rifiutato'))
      .catch(err => alert('Errore nel rifiuto del voto: ' + err));
  }

  // Funzione per prenotare un esame
  function prenotaEsame(appelloId) {
    eseguiOperazione('prenotaEsame', [appelloId, matricola])
      .then(() => alert('Esame prenotato con successo'))
      .catch(err => alert('Errore nella prenotazione dell\'esame: ' + err));
  }
</script>

</body>
</html>
