<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Studente</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
          background-color: #f8f9fa;
        }

        header {
          background-color: #198754;
          color: white;
          padding: 20px 40px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        header h1 {
          margin: 0;
          font-size: 1.75rem;
        }

        .btn-light {
          background-color: white;
          color: #198754;
          border: none;
          transition: background-color 0.3s;
        }

        .btn-light:hover {
          background-color: #e2f4ec;
        }

        .card {
          border: none;
          box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .card-header {
          background-color: #198754;
          color: white;
          font-weight: bold;
        }

        .list-group-item {
          border: 1px solid #ddd;
          border-radius: 0.5rem;
          margin-bottom: 10px;
          padding: 15px;
          background-color: white;
        }

        .list-group-item:hover {
          background-color: #f1fdf7;
        }

        h2, h4 {
          color: #198754;
          font-weight: 600;
        }

        footer {
          background-color: #fff;
          border-top: 1px solid #ddd;
          padding: 20px;
          text-align: center;
          color: #6c757d;
        }

        .btn-primary {
          background-color: #198754;
          border-color: #198754;
        }

        .btn-primary:hover {
          background-color: #157347;
          border-color: #157347;
        }

        .badge-success {
          background-color: #198754;
        }
    </style>
</head>
<body>

<header>
    <h1>Area Studente</h1>
    <div>
        <span id="nomeStudente" class="me-3 fw-semibold"></span>
        <button class="btn btn-light btn-sm" id="logoutBtn">Logout</button>
    </div>
</header>

<div class="container mt-5">
    <div id="contenuto-dashboard">
        <h2 class="mb-3">Bentornato <span id="nomeCompleto"></span>!</h2>
        <p class="lead">Gestisci il tuo piano di studi, prenotazioni e voti.</p>

        <div class="card my-4">
            <div class="card-header">
                Piano di Studi
            </div>
            <div class="card-body">
                <h5 id="piano-studi" class="card-title text-success">Caricamento...</h5>
            </div>
        </div>

        <div id="sezione-carriera" class="my-4">
            <h4>Carriera in corso</h4>
            <ul id="carriera" class="list-group"></ul>
        </div>

        <div id="sezione-voti" class="my-4">
            <h4>Voti da accettare</h4>
            <ul id="lista-voti" class="list-group"></ul>
        </div>
    </div>
</div>

<footer class="mt-5 border-top">
    <small>&copy; 2025 - Segreteria Universitaria. Tutti i diritti riservati.</small>
</footer>

<script type="module">
    import {
        getInfoStudente,
        getPianoDiStudi,
        getVotiDaAccettare,
        aggiornaStatoVoto,
        prenotaEsame,
        getCarriera
    } from '/js/service/studente.js';

    import { logout } from '/js/service/service.js';

    document.getElementById("logoutBtn").addEventListener("click", logout);

    // Carica informazioni studente
    getInfoStudente()
        .then(data => {
            document.getElementById('nomeStudente').innerText = `${data.nome} ${data.cognome}`;
            document.getElementById('nomeCompleto').innerText = data.nome;
        })
        .catch(err => console.error("Errore caricamento info studente:", err));

    // Carica piano di studi
    getPianoDiStudi()
        .then(piano => {
            document.getElementById('piano-studi').innerText = piano || 'Non disponibile';
        })
        .catch(err => console.error("Errore caricamento piano di studi:", err));

    // Carica carriera esami
    getCarriera()
        .then(esami => {
            const lista = document.getElementById('carriera');
            lista.innerHTML = '';

            esami.forEach(e => {
                const item = document.createElement('li');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';

                // Nome esame
                const nomeSpan = document.createElement('span');
                nomeSpan.innerText = e.nome;
                item.appendChild(nomeSpan);

                const right = document.createElement('div');

                if (e.statoEsame === 'SUPERATO') {
                    const cfuSpan = document.createElement('span');
                    cfuSpan.className = 'badge bg-success rounded-pill';
                    cfuSpan.innerText = `${e.cfu} CFU`;
                    right.appendChild(cfuSpan);
                } else if (e.idAppello) {
                    const prenotaBtn = document.createElement('button');
                    prenotaBtn.className = 'btn btn-primary btn-sm';
                    prenotaBtn.innerText = 'Prenota';
                    prenotaBtn.onclick = () => {
                        prenotaEsame(e.idAppello)
                            .then(() => alert('Esame prenotato con successo'))
                            .catch(err => alert('Errore nella prenotazione: ' + err));
                    };
                    right.appendChild(prenotaBtn);
                } else {
                    const noAppello = document.createElement('span');
                    noAppello.className = 'text-muted fst-italic';
                    noAppello.innerText = 'Nessun appello disponibile';
                    right.appendChild(noAppello);
                }

                item.appendChild(right);
                lista.appendChild(item);
            });
        })
        .catch(err => console.error("Errore caricamento situazione esami:", err));

    // Carica voti da accettare
    getVotiDaAccettare()
        .then(voti => {
            const lista = document.getElementById('lista-voti');
            lista.innerHTML = '';

            voti.forEach(v => {
                const item = document.createElement('li');
                item.className = 'list-group-item d-flex justify-content-between align-items-center flex-wrap';

                const testoVoto = document.createElement('div');
                testoVoto.innerText = `${v.esame.nome} - Voto: ${v.valutazione}`;
                testoVoto.className = 'me-3 fw-semibold';

                const btnGroup = document.createElement('div');
                btnGroup.className = 'd-flex gap-2';

                const accettaBtn = document.createElement('button');
                accettaBtn.className = 'btn btn-success btn-sm';
                accettaBtn.innerText = 'Accetta';
                accettaBtn.onclick = () => {
                    aggiornaStatoVoto(v.id, true)
                        .then(() => alert('Voto accettato'))
                        .catch(err => alert('Errore: ' + err));
                };

                const rifiutaBtn = document.createElement('button');
                rifiutaBtn.className = 'btn btn-danger btn-sm';
                rifiutaBtn.innerText = 'Rifiuta';
                rifiutaBtn.onclick = () => {
                    aggiornaStatoVoto(v.id, false)
                        .then(() => alert('Voto rifiutato'))
                        .catch(err => alert('Errore: ' + err));
                };

                btnGroup.appendChild(accettaBtn);
                btnGroup.appendChild(rifiutaBtn);

                item.appendChild(testoVoto);
                item.appendChild(btnGroup);
                lista.appendChild(item);
            });

            if (voti.length === 0) {
                const noVoti = document.createElement('li');
                noVoti.className = 'list-group-item text-center text-muted fst-italic';
                noVoti.innerText = 'Nessun voto da accettare';
                lista.appendChild(noVoti);
            }
        })
        .catch(err => console.error("Errore caricamento voti:", err));
</script>

</body>
</html>
